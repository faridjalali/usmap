<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Donlon Maps</title>
    
    <link rel="icon" href="icon_0.jpg" type="image/jpeg">

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson-client@3"></script>
    
    <style>
        :root {
            --bg-deep: #050505;
            --map-stroke: rgba(255, 255, 255, 0.15);
            --neon-blue: #00f3ff;
            --neon-pink: #ff0055;
            --neon-green: #00ff9d;
            --neon-amber: #ffaa00;
            --glass: rgba(15, 15, 15, 0.85);
            --font-main: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            
            /* Regional Colors (RGBA for Translucency) */
            --c-southwest: rgba(255, 153, 153, 0.25); /* Translucent Red */
            --c-western: rgba(153, 255, 153, 0.25);   /* Translucent Green */
            --c-northeast: rgba(153, 204, 255, 0.25); /* Translucent Blue */
            --c-midwest: rgba(255, 204, 153, 0.25);   /* Translucent Orange */
            --c-southeast: rgba(210, 180, 140, 0.25); /* Translucent Brown */
        }

        body {
            margin: 0;
            background-color: var(--bg-deep);
            color: white;
            font-family: var(--font-main);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            user-select: none;
            touch-action: none;
        }

        #map-stage { width: 100%; height: 100%; cursor: crosshair; }

        .state {
            stroke: var(--map-stroke);
            stroke-width: 0.5px;
            transition: fill 0.3s ease, opacity 0.3s ease, stroke-width 0.2s;
            vector-effect: non-scaling-stroke;
        }

        /* Regional Fill Classes */
        .reg-southwest { fill: var(--c-southwest); }
        .reg-western { fill: var(--c-western); }
        .reg-northeast { fill: var(--c-northeast); }
        .reg-midwest { fill: var(--c-midwest); }
        .reg-southeast { fill: var(--c-southeast); }

        .state:hover { opacity: 0.8; stroke: rgba(255,255,255,0.4); stroke-width: 1px; }
        .state.active-focused { opacity: 1; stroke: #fff; stroke-width: 2px; }

        /* Flash effects adjusted for translucency */
        .state.correct-flash { animation: flashSuccess 0.5s forwards; }
        .state.wrong-flash { animation: flashError 0.5s forwards; }

        @keyframes flashSuccess { 0% { fill: var(--neon-green); opacity: 1; } 100% { fill: inherit; opacity: 0.25; } }
        @keyframes flashError { 0% { fill: var(--neon-pink); opacity: 1; } 100% { fill: inherit; opacity: 0.25; } }

        .city-node {
            fill: var(--neon-blue);
            stroke: rgba(0, 243, 255, 0.2);
            stroke-width: 5px; 
            cursor: pointer;
            transition: all 0.3s ease;
            pointer-events: none; 
        }

        .city-node:hover { fill: #fff; stroke: var(--neon-blue); stroke-width: 8px; }
        .city-node.wrong-choice { fill: var(--neon-pink); stroke: var(--neon-pink); pointer-events: none; opacity: 0.6; }
        .city-node.correct-choice { fill: var(--neon-green); stroke: var(--neon-green); }

        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }

        #top-hud {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            background: var(--glass); border: 1px solid rgba(255,255,255,0.1);
            padding: 10px 30px; border-radius: 50px; display: flex; gap: 40px;
            backdrop-filter: blur(15px); z-index: 10;
        }

        .hud-group { display: flex; flex-direction: column; align-items: center; min-width: 70px; }
        .hud-item { font-size: 0.7rem; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 2px; }
        .hud-val { color: var(--neon-blue); font-weight: 800; font-size: 1.2rem; text-shadow: 0 0 10px rgba(0, 243, 255, 0.4); }

        #prompt-container { position: absolute; top: 15%; width: 100%; text-align: center; text-shadow: 0 5px 25px black; }
        #main-prompt { font-size: 2.2rem; font-weight: 900; text-transform: uppercase; margin: 0; transition: all 0.4s; letter-spacing: 1px; }
        #sub-prompt { font-size: 1.1rem; color: var(--neon-blue); margin-top: 8px; letter-spacing: 1px; line-height: 1.4; }

        .wrong-state-highlight { color: var(--neon-amber); text-decoration: none; font-weight: 800; }

        #city-tooltip {
            position: absolute; background: rgba(0,0,0,0.9); border: 1px solid var(--neon-blue);
            color: white; padding: 5px 12px; border-radius: 4px; font-size: 0.85rem;
            pointer-events: none; opacity: 0; transform: translate(-50%, -150%);
            white-space: nowrap; z-index: 50;
        }

        #fact-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95);
            backdrop-filter: blur(20px); z-index: 100; display: flex;
            justify-content: center; align-items: center; opacity: 0;
            pointer-events: none; transition: opacity 0.3s;
        }
        #fact-overlay.show { opacity: 1; pointer-events: auto; }

        .fact-card {
            background: #111; border: 2px solid var(--neon-blue); border-radius: 20px;
            padding: 45px; max-width: 500px; width: 92%; text-align: center;
            box-shadow: 0 0 70px rgba(0, 243, 255, 0.15);
        }

        .fact-status { font-weight: 800; letter-spacing: 4px; margin-bottom: 12px; font-size: 1.1rem; text-transform: uppercase; }
        .status-correct { color: var(--neon-green); }
        .status-wrong { color: var(--neon-pink); }
        .status-info { color: var(--neon-amber); }
        
        .fact-city { font-size: 2.6rem; margin: 0 0 15px; color: white; font-weight: 900; }
        .fact-body { color: #ddd; line-height: 1.7; margin-bottom: 35px; font-size: 1.1rem; }

        .next-btn {
            background: var(--neon-blue); color: #000; border: none;
            padding: 16px 45px; font-weight: 800; border-radius: 40px;
            cursor: pointer; text-transform: uppercase; transition: 0.2s;
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.3);
        }
        .next-btn:hover { background: white; transform: scale(1.05); box-shadow: 0 0 30px rgba(255,255,255,0.4); }

    </style>
</head>
<body>

    <div id="city-tooltip">City Name</div>
    <div id="map-stage"></div>

    <div id="ui-layer">
        <div id="top-hud">
            <div class="hud-group">
                <span class="hud-item">Target</span>
                <span id="target-state" class="hud-val">--</span>
            </div>
            <div class="hud-group">
                <span class="hud-item">Score</span>
                <span id="score-val" class="hud-val">0</span>
            </div>
        </div>
        <div id="prompt-container">
            <h1 id="main-prompt">Initializing Satellite...</h1>
            <div id="sub-prompt"></div>
        </div>
    </div>

    <div id="fact-overlay">
        <div class="fact-card">
            <div class="fact-status" id="fact-status">Result</div>
            <div class="fact-city" id="fact-city-name">City</div>
            <div class="fact-body" id="fact-text">Fact</div>
            <button class="next-btn" id="next-action-btn">Continue</button>
        </div>
    </div>

    <script>
        const gameData = {
            "AL": { name: "Alabama", region: "southeast", capital: "Montgomery", cities: { "Montgomery": [-86.3077, 32.3792], "Birmingham": [-86.8104, 33.5186], "Mobile": [-88.0399, 30.6954], "Huntsville": [-86.5861, 34.7304], "Tuscaloosa": [-87.5692, 33.2098] }, facts: { "Montgomery": "Capital since 1846, it was the first capital of the Confederacy.", "Birmingham": "The 'Pittsburgh of the South' due to its iron and steel industry.", "Mobile": "Site of the first US Mardi Gras and only saltwater port in AL.", "Huntsville": "The 'Rocket City' where NASA developed Saturn V rockets.", "Tuscaloosa": "Home of the University of Alabama, named after Chief Tuskaloosa." } },
            "AK": { name: "Alaska", region: "western", capital: "Juneau", cities: { "Juneau": [-134.4197, 58.3019], "Anchorage": [-149.9003, 61.2181], "Fairbanks": [-147.7164, 64.8378], "Sitka": [-135.3300, 57.0531], "Ketchikan": [-131.6461, 55.3422] }, facts: { "Juneau": "Only reachable by air or sea; no roads lead here from the outside.", "Anchorage": "Nearly 40% of the state's population resides here.", "Fairbanks": "Known as the Golden Heart City, prime for Northern Lights viewing.", "Sitka": "Former capital of Russian America before the 1867 purchase.", "Ketchikan": "The 'Salmon Capital of the World' with many totem poles." } },
            "AZ": { name: "Arizona", region: "southwest", capital: "Phoenix", cities: { "Phoenix": [-112.0740, 33.4484], "Tucson": [-110.9747, 32.2226], "Mesa": [-111.8315, 33.4152], "Scottsdale": [-111.9261, 33.4942], "Flagstaff": [-111.6513, 35.1983] }, facts: { "Phoenix": "Most populous state capital in the United States.", "Tucson": "Surrounded by mountain ranges and home to historic missions.", "Mesa": "Features the largest performing arts complex in the Southwest desert.", "Scottsdale": "Famous for high-end resorts and its 'Old Town' western charm.", "Flagstaff": "Located at high elevation; Pluto was discovered here in 1930." } },
            "AR": { name: "Arkansas", region: "southeast", capital: "Little Rock", cities: { "Little Rock": [-92.2896, 34.7465], "Fayetteville": [-94.1574, 36.0626], "Fort Smith": [-94.4229, 35.3859], "Springdale": [-94.1288, 36.1867], "Hot Springs": [-93.0552, 34.5037] }, facts: { "Little Rock": "Named for a rock formation used as a landmark by explorers.", "Fayetteville": "The cultural heart of the Ozarks and home to the Razorbacks.", "Fort Smith": "Former frontier town famous for Judge Isaac Parker.", "Springdale": "Poultry capital of the world and home to Tyson Foods.", "Hot Springs": "Famous for its thermal waters and protected National Park." } },
            "CA": { name: "California", region: "western", capital: "Sacramento", cities: { "Sacramento": [-121.4944, 38.5816], "Los Angeles": [-118.2437, 34.0522], "San Francisco": [-122.4194, 37.7749], "San Diego": [-117.1611, 32.7157], "San Jose": [-121.8863, 37.3382] }, facts: { "Sacramento": "Became capital in 1854 during the peak of the Gold Rush.", "Los Angeles": "Economic powerhouse larger than many national economies.", "San Francisco": "Home to the world's last manually operated cable car system.", "San Diego": "The birthplace of California with a near-perfect climate.", "San Jose": "First capital of CA and the 'Capital of Silicon Valley'." } },
            "CO": { name: "Colorado", region: "western", capital: "Denver", cities: { "Denver": [-104.9903, 39.7392], "Colorado Springs": [-104.8214, 38.8339], "Aurora": [-104.8319, 39.7294], "Fort Collins": [-105.0844, 40.5853], "Boulder": [-105.2705, 40.0150] }, facts: { "Denver": "Mile High City; elevation is exactly 5,280 feet.", "Colorado Springs": "Home to the US Olympic Committee at the foot of Pikes Peak.", "Aurora": "Diverse city housing the Buckley Space Force Base.", "Fort Collins": "The inspiration for Disneyland's Main Street, USA.", "Boulder": "Nestled against the Flatirons, often ranked 'happiest city'." } },
            "CT": { name: "Connecticut", region: "northeast", capital: "Hartford", cities: { "Hartford": [-72.6734, 41.7658], "Bridgeport": [-73.1894, 41.1792], "New Haven": [-72.9279, 41.3083], "Stamford": [-73.5387, 41.0534], "Waterbury": [-73.0454, 41.5582] }, facts: { "Hartford": "Home to the oldest public art museum in the US.", "Bridgeport": "Birthplace of P.T. Barnum and the 'Brass City' hub.", "New Haven": "Home to Yale and the birthplace of the hamburger.", "Stamford": "HQ for many major Fortune 500 corporations.", "Waterbury": "Once the world's center for brass manufacturing." } },
            "DE": { name: "Delaware", region: "northeast", capital: "Dover", cities: { "Dover": [-75.5297, 39.1582], "Wilmington": [-75.5484, 39.7447], "Newark": [-75.7497, 39.6837], "Middletown": [-75.7163, 39.4496], "Smyrna": [-75.6049, 39.2998] }, facts: { "Dover": "Founded by William Penn in 1683; major NASCAR site.", "Wilmington": "A national center for the chemical and credit industries.", "Newark": "Home to the University of Delaware.", "Middletown": "Fast-growing town known for its historic downtown area.", "Smyrna": "Named after an ancient Greek city in modern Turkey." } },
            "FL": { name: "Florida", region: "southeast", capital: "Tallahassee", cities: { "Tallahassee": [-84.2807, 30.4383], "Miami": [-80.1918, 25.7617], "Orlando": [-81.3792, 28.5383], "Tampa": [-82.4572, 27.9506], "Jacksonville": [-81.6557, 30.3322] }, facts: { "Tallahassee": "Only Confederate capital east of MS not captured in Civil War.", "Miami": "Only major US city founded by a woman (Julia Tuttle).", "Orlando": "Most-visited destination in the US due to theme parks.", "Tampa": "Famous for its historic Ybor City cigar-making district.", "Jacksonville": "Largest city by land area in the contiguous United States." } },
            "GA": { name: "Georgia", region: "southeast", capital: "Atlanta", cities: { "Atlanta": [-84.3880, 33.7490], "Savannah": [-81.0998, 32.0809], "Augusta": [-81.9748, 33.4735], "Macon": [-83.6324, 32.8407], "Columbus": [-84.9901, 32.4610] }, facts: { "Atlanta": "Symbol is the Phoenix, rebuilt after burning in the Civil War.", "Savannah": "First planned city in the US, established in 1733.", "Augusta": "Home to the Masters, golf's most prestigious tournament.", "Macon": "Cherry Blossom Capital with 300,000+ Yoshino trees.", "Columbus": "Home to the National Infantry Museum and whitewater course." } },
            "HI": { name: "Hawaii", region: "western", capital: "Honolulu", cities: { "Honolulu": [-157.8583, 21.3069], "Hilo": [-155.0844, 19.7297], "Kailua": [-157.7394, 21.4022], "Kapolei": [-158.0772, 21.3328], "Lihue": [-159.3711, 21.9811] }, facts: { "Honolulu": "Remote-most large city; home to the only US royal palace.", "Hilo": "Known for waterfalls and the world's most active volcano.", "Kailua": "Famous for Lanikai Beach's pristine white sands.", "Kapolei": "The 'Second City' of Oahu, designed to ease congestion.", "Lihue": "Commercial and government hub of the island of Kauai." } },
            "ID": { name: "Idaho", region: "western", capital: "Boise", cities: { "Boise": [-116.2023, 43.6150], "Meridian": [-116.3915, 43.6121], "Nampa": [-116.5635, 43.5407], "Idaho Falls": [-112.0340, 43.4917], "Pocatello": [-112.4506, 42.8666] }, facts: { "Boise": "Name comes from French 'Les Bois' (The Woods).", "Meridian": "Fastest growing city in ID and a major retail hub.", "Nampa": "The center of Idaho's emerging wine country.", "Idaho Falls": "Site of a major hydroelectric plant on the Snake River.", "Pocatello": "Known as the 'Gate City' for rail and road travel." } },
            "IL": { name: "Illinois", region: "midwest", capital: "Springfield", cities: { "Springfield": [-89.6501, 39.7817], "Chicago": [-87.6298, 41.8781], "Aurora": [-88.3156, 41.7606], "Rockford": [-89.0939, 42.2711], "Joliet": [-88.0817, 41.5250] }, facts: { "Springfield": "Where Abraham Lincoln lived and practiced law.", "Chicago": "The birthplace of the skyscraper and deep-dish pizza.", "Aurora": "First US city to use electric street lighting (1881).", "Rockford": "Famous for the Peaches, the first women's pro baseball team.", "Joliet": "Home to a historic prison and the first Dairy Queen." } },
            "IN": { name: "Indiana", region: "midwest", capital: "Indianapolis", cities: { "Indianapolis": [-86.1581, 39.7684], "Fort Wayne": [-85.1394, 41.0793], "Evansville": [-87.5711, 37.9716], "South Bend": [-86.2520, 41.6764], "Gary": [-87.3464, 41.5940] }, facts: { "Indianapolis": "Features the second most war memorials in the US.", "Fort Wayne": "The 'City of Churches' named after Gen. Anthony Wayne.", "Evansville": "Commercial hub of the IL/IN/KY tri-state area.", "South Bend": "Home to the University of Notre Dame.", "Gary": "The industrial birthplace of Michael Jackson." } },
            "IA": { name: "Iowa", region: "midwest", capital: "Des Moines", cities: { "Des Moines": [-93.6091, 41.6005], "Cedar Rapids": [-91.6656, 41.9779], "Davenport": [-90.5776, 41.5236], "Sioux City": [-96.4103, 42.4999], "Iowa City": [-91.5302, 41.6611] }, facts: { "Des Moines": "A major global center for the insurance industry.", "Cedar Rapids": "Only US city with government offices on an island.", "Davenport": "Largest city on the MS River without a permanent floodwall.", "Sioux City": "Historic site of the Lewis and Clark expedition.", "Iowa City": "UNESCO City of Literature and the first capital of IA." } },
            "KS": { name: "Kansas", region: "midwest", capital: "Topeka", cities: { "Topeka": [-95.6890, 39.0473], "Wichita": [-97.3301, 37.6872], "Overland Park": [-94.6708, 38.9822], "Kansas City": [-94.6274, 39.1140], "Lawrence": [-95.2353, 38.9717] }, facts: { "Topeka": "Site of the Brown v. Board of Education landmark case.", "Wichita": "Air Capital of the World for its aircraft manufacturing.", "Overland Park": "Consistently ranked among the best places to live in the US.", "Kansas City": "World-famous for its unique style of barbecue.", "Lawrence": "Founded as an abolitionist stronghold in 1854." } },
            "KY": { name: "Kentucky", region: "southeast", capital: "Frankfort", cities: { "Frankfort": [-84.8705, 38.2009], "Louisville": [-85.7585, 38.2527], "Lexington": [-84.5037, 38.0406], "Bowling Green": [-86.4436, 36.9685], "Owensboro": [-87.1181, 37.7719] }, facts: { "Frankfort": "Smallest US capital on a major river (the Kentucky).", "Louisville": "Home of the Kentucky Derby and Muhammad Ali.", "Lexington": "The Bluegrass heart and Horse Capital of the World.", "Bowling Green": "Where every Chevrolet Corvette is manufactured.", "Owensboro": "The world's capital for mutton-based barbecue." } },
            "LA": { name: "Louisiana", region: "southeast", capital: "Baton Rouge", cities: { "Baton Rouge": [-91.1403, 30.4583], "New Orleans": [-90.0715, 29.9511], "Shreveport": [-93.7502, 32.5252], "Lafayette": [-92.0198, 30.2241], "Lake Charles": [-93.2174, 30.2265] }, facts: { "Baton Rouge": "French for 'Red Stick', marking hunting boundaries.", "New Orleans": "The birthplace of Jazz and world-class Creole cuisine.", "Shreveport": "Former capital of LA during the Civil War.", "Lafayette": "The cultural hub of the Cajun and Zydeco the world.", "Lake Charles": "Festival capital of LA with 75+ yearly events." } },
            "ME": { name: "Maine", region: "northeast", capital: "Augusta", cities: { "Augusta": [-69.7795, 44.3106], "Portland": [-70.2568, 43.6591], "Lewiston": [-70.2148, 44.1004], "Bangor": [-68.7778, 44.8016], "Auburn": [-70.2312, 44.0979] }, facts: { "Augusta": "The easternmost state capital in the US.", "Portland": "Historic seaport with iconic lighthouse views.", "Lewiston": "Site of the 1965 Ali-Liston heavyweight title fight.", "Bangor": "Home to Stephen King and a giant Paul Bunyan statue.", "Auburn": "Formerly a major global center for shoe manufacturing." } },
            "MD": { name: "Maryland", region: "northeast", capital: "Annapolis", cities: { "Annapolis": [-76.4922, 38.9784], "Baltimore": [-76.6122, 39.2904], "Frederick": [-77.4105, 39.4143], "Gaithersburg": [-77.1944, 39.1434], "Ocean City": [-75.0849, 38.3365] }, facts: { "Annapolis": "Served as the nation's temporary capital (1783-84).", "Baltimore": "Birthplace of the Star-Spangled Banner.", "Frederick": "Home to the National Museum of Civil War Medicine.", "Gaithersburg": "A major science and biotech hub for the East Coast.", "Ocean City": "Famous for its historic wooden boardwalk and beach." } },
            "MA": { name: "Massachusetts", region: "northeast", capital: "Boston", cities: { "Boston": [-71.0589, 42.3601], "Worcester": [-71.8023, 42.2626], "Springfield": [-72.5898, 42.1015], "Cambridge": [-71.1097, 42.3736], "Lowell": [-71.3162, 42.6334] }, facts: { "Boston": "Home to the nation's first public park and subway.", "Worcester": "Birthplace of the liquid fuel rocket.", "Springfield": "The birthplace of basketball and Dr. Seuss.", "Cambridge": "Home to Harvard, the oldest US university (1636).", "Lowell": "The cradle of the American Industrial Revolution." } },
            "MI": { name: "Michigan", region: "midwest", capital: "Lansing", cities: { "Lansing": [-84.5555, 42.7325], "Detroit": [-83.0458, 42.3314], "Grand Rapids": [-85.6681, 42.9634], "Ann Arbor": [-83.7430, 42.2808], "Flint": [-83.6875, 43.0125] }, facts: { "Lansing": "Only US capital in a township of the same name.", "Detroit": "Motor City; the first city to assign phone numbers.", "Grand Rapids": "Furniture City and the birthplace of Gerald Ford.", "Ann Arbor": "Home to the massive Michigan Stadium ('The Big House').", "Flint": "The industrial birthplace of General Motors." } },
            "MN": { name: "Minnesota", region: "midwest", capital: "Saint Paul", cities: { "Saint Paul": [-93.0899, 44.9537], "Minneapolis": [-93.2650, 44.9778], "Rochester": [-92.4802, 44.0121], "Duluth": [-92.1005, 46.7867], "Bloomington": [-93.2983, 44.8408] }, facts: { "Saint Paul": "Originally named 'Pig's Eye' after a tavern owner.", "Minneapolis": "City of Lakes; features 22 lakes within city limits.", "Rochester": "Home to the world-renowned Mayo Clinic.", "Duluth": "The world's most inland freshwater seaport.", "Bloomington": "Home to the Mall of America, the largest US mall." } },
            "MS": { name: "Mississippi", region: "southeast", capital: "Jackson", cities: { "Jackson": [-90.1848, 32.2988], "Gulfport": [-89.0928, 30.3674], "Biloxi": [-88.8853, 30.3960], "Hattiesburg": [-89.2903, 31.3271], "Tupelo": [-88.7034, 34.2576] }, facts: { "Jackson": "Sits atop an extinct volcano; named for Andrew Jackson.", "Gulfport": "A critical seaport and home to the Navy Seabees.", "Biloxi": "Known for its lighthouse and vibrant casino industry.", "Hattiesburg": "Hub City, where major rails and roads intersect.", "Tupelo": "The birthplace of the King of Rock, Elvis Presley." } },
            "MO": { name: "Missouri", region: "midwest", capital: "Jefferson City", cities: { "Jefferson City": [-92.1735, 38.5767], "Kansas City": [-94.5786, 39.0997], "St. Louis": [-90.1994, 38.6270], "Springfield": [-93.2923, 37.2089], "Branson": [-93.2185, 36.6437] }, facts: { "Jefferson City": "Named for Thomas Jefferson, the 3rd US President.", "Kansas City": "Features more fountains than any city except Rome.", "St. Louis": "Home to the world's tallest arch (Gateway Arch).", "Springfield": "The official birthplace of Route 66.", "Branson": "The Live Music Show Capital of the World." } },
            "MT": { name: "Montana", region: "western", capital: "Helena", cities: { "Helena": [-112.0270, 46.5891], "Billings": [-108.5007, 45.7833], "Missoula": [-113.9966, 46.8721], "Great Falls": [-111.3218, 47.5053], "Bozeman": [-111.0429, 45.6770] }, facts: { "Helena": "Founded in 1864 after gold was found in Last Chance Gulch.", "Billings": "Surrounded by iconic sandstone cliffs called 'The Rimrocks'.", "Missoula": "Known as the Garden City; base for Smokejumpers.", "Great Falls": "Electric City; home to five major hydroelectric dams.", "Bozeman": "Gateway to Yellowstone and home to the Museum of the Rockies." } },
            "NE": { name: "Nebraska", region: "midwest", capital: "Lincoln", cities: { "Lincoln": [-96.7026, 40.8136], "Omaha": [-95.9345, 41.2565], "Bellevue": [-95.9403, 41.1578], "Grand Island": [-98.3414, 40.9264], "Kearney": [-99.0817, 40.6995] }, facts: { "Lincoln": "Home to the unique unicameral state legislature.", "Omaha": "Birthplace of the Reuben sandwich and the TV dinner.", "Bellevue": "The oldest city in Nebraska; 'beautiful view' in French.", "Grand Island": "Three-time 'All-America City' award winner.", "Kearney": "Major stop for Sandhill Cranes during migration." } },
            "NV": { name: "Nevada", region: "western", capital: "Carson City", cities: { "Carson City": [-119.7674, 39.1638], "Las Vegas": [-115.1398, 36.1699], "Henderson": [-114.9817, 36.0395], "Reno": [-119.8138, 39.5296], "Elko": [-115.7631, 40.8324] }, facts: { "Carson City": "Independent city named after explorer Kit Carson.", "Las Vegas": "Entertainment Capital of the World.", "Henderson": "Home to the Ethel M Chocolate Factory and gardens.", "Reno": "The Biggest Little City in the World.", "Elko": "The heart of Nevada's massive gold mining industry." } },
            "NH": { name: "New Hampshire", region: "northeast", capital: "Concord", cities: { "Concord": [-71.5376, 43.2081], "Manchester": [-71.4548, 42.9956], "Nashua": [-71.4676, 42.7654], "Derry": [-71.3273, 42.8806], "Portsmouth": [-70.7626, 43.0718] }, facts: { "Concord": "Invented the first modern alarm clock in 1787.", "Manchester": "Largest city in NH and a former global textile hub.", "Nashua": "Twice named 'Best Place to Live' by Money magazine.", "Derry": "Childhood home of Alan Shepard, 1st American in space.", "Portsmouth": "The state's primary deep-water seaport (est. 1623)." } },
            "NJ": { name: "New Jersey", region: "northeast", capital: "Trenton", cities: { "Trenton": [-74.7429, 40.2206], "Newark": [-74.1724, 40.7357], "Jersey City": [-74.0431, 40.7178], "Paterson": [-74.1718, 40.9168], "Atlantic City": [-74.4229, 39.3643] }, facts: { "Trenton": "Site of Washington's decisive victory after the crossing.", "Newark": "Major shipping and air hub for the NY/NJ area.", "Jersey City": "Known as NYC's 'Sixth Borough' for its skyline views.", "Paterson": "Silk City; the nation's first planned industrial park.", "Atlantic City": "Home to the first boardwalk and Monopoly's street names." } },
            "NM": { name: "New Mexico", region: "southwest", capital: "Santa Fe", cities: { "Santa Fe": [-105.9378, 35.6870], "Albuquerque": [-106.6056, 35.0844], "Las Cruces": [-106.7785, 32.3199], "Rio Rancho": [-106.6622, 35.2328], "Roswell": [-104.5230, 33.3943] }, facts: { "Santa Fe": "Oldest US capital (1610) and the highest (7,199 ft).", "Albuquerque": "The Hot Air Balloon Capital of the World.", "Las Cruces": "Home to New Mexico State University; 'City of the Crosses'.", "Rio Rancho": "The economic hub of Sandoval County and tech center.", "Roswell": "Site of the famous 1947 UFO incident." } },
            "NY": { name: "New York", region: "northeast", capital: "Albany", cities: { "Albany": [-73.7562, 42.6526], "New York City": [-74.0060, 40.7128], "Buffalo": [-78.8784, 42.8864], "Rochester": [-77.6109, 43.1610], "Syracuse": [-76.1474, 43.0481] }, facts: { "Albany": "One of the oldest surviving settlements in the 13 colonies.", "New York City": "Global center for finance, culture, and media.", "Buffalo": "Birthplace of the Buffalo wing at the Anchor Bar.", "Rochester": "The Flower City; former HQ for Kodak and Xerox.", "Syracuse": "Known for salt springs; host of the Great NY State Fair." } },
            "NC": { name: "North Carolina", region: "southeast", capital: "Raleigh", cities: { "Raleigh": [-78.6382, 35.7796], "Charlotte": [-80.8431, 35.2271], "Greensboro": [-79.7920, 36.0726], "Durham": [-78.8986, 35.9940], "Winston-Salem": [-80.2442, 36.0999] }, facts: { "Raleigh": "City of Oaks and part of the Research Triangle Park.", "Charlotte": "The second-largest banking hub in the United States.", "Greensboro": "Site of the 1960 Civil Rights Woolworth's sit-ins.", "Durham": "Home to Duke University and known as the 'City of Medicine'.", "Winston-Salem": "The historic heart of the tobacco and textile industries." } },
            "ND": { name: "North Dakota", region: "midwest", capital: "Bismarck", cities: { "Bismarck": [-100.7837, 46.8083], "Fargo": [-96.7898, 46.8772], "Grand Forks": [-97.0329, 47.9253], "Minot": [-101.2963, 48.2325], "Williston": [-103.6256, 48.1470] }, facts: { "Bismarck": "Named for German Chancellor Otto von Bismarck.", "Fargo": "Largest city in the state, located on the Red River.", "Grand Forks": "Home to the University of ND aerospace program.", "Minot": "Magic City, known for rapid growth during the rail boom.", "Williston": "Heart of the Bakken oil boom." } },
            "OH": { name: "Ohio", region: "midwest", capital: "Columbus", cities: { "Columbus": [-82.9988, 39.9612], "Cleveland": [-81.6944, 41.4993], "Cincinnati": [-84.5120, 39.1031], "Toledo": [-83.5552, 41.6528], "Akron": [-81.5190, 41.0814] }, facts: { "Columbus": "Fastest-growing city in the Midwest; home to the Buckeyes.", "Cleveland": "Home to the Rock and Roll Hall of Fame.", "Cincinnati": "Queen City; site of the first US pro baseball team.", "Toledo": "Glass City; center of the US glass industry.", "Akron": "Rubber Capital; birthplace of Goodyear and Firestone." } },
            "OK": { name: "Oklahoma", region: "southwest", capital: "Oklahoma City", cities: { "Oklahoma City": [-97.5164, 35.4676], "Tulsa": [-95.9928, 36.1540], "Norman": [-97.4395, 35.2226], "Broken Arrow": [-95.7908, 36.0526], "Lawton": [-98.3903, 34.6036] }, facts: { "Oklahoma City": "Only capital with working oil wells on its grounds.", "Tulsa": "Art Deco treasure and former 'Oil Capital of the World'.", "Norman": "Home to the National Weather Center.", "Broken Arrow": "Largest manufacturing hub in OK.", "Lawton": "Near the scenic Wichita Mountains Wildlife Refuge." } },
            "OR": { name: "Oregon", region: "western", capital: "Salem", cities: { "Salem": [-123.0351, 44.9429], "Portland": [-122.6784, 45.5152], "Eugene": [-123.0868, 44.0521], "Gresham": [-122.4312, 45.4985], "Medford": [-122.8752, 42.3265] }, facts: { "Salem": "Name means 'Peace'; capital since 1851.", "Portland": "Known for the massive Powell's City of Books.", "Eugene": "Track Town USA and the birthplace of Nike.", "Gresham": "Located at the foot of Mt. Hood in the Willamette Valley.", "Medford": "Agricultural center for pears (Harry & David)." } },
            "PA": { name: "Pennsylvania", region: "northeast", capital: "Harrisburg", cities: { "Harrisburg": [-76.8867, 40.2732], "Philadelphia": [-75.1652, 39.9526], "Pittsburgh": [-79.9959, 40.4406], "Allentown": [-75.4902, 40.6023], "Erie": [-80.0850, 42.1292] }, facts: { "Harrisburg": "Features a capitol dome inspired by St. Peter's in Rome.", "Philadelphia": "The first US capital and home to the Liberty Bell.", "Pittsburgh": "Steel City; features 446 bridges, more than Venice.", "Allentown": "Where the Liberty Bell was hidden during the Revolution.", "Erie": "The state's primary lake port on the Great Lakes." } },
            "RI": { name: "Rhode Island", region: "northeast", capital: "Providence", cities: { "Providence": [-71.4128, 41.8240], "Warwick": [-71.4162, 41.7001], "Cranston": [-71.4406, 41.7798], "Pawtucket": [-71.3824, 41.8787], "Newport": [-71.3128, 41.4901] }, facts: { "Providence": "One of the oldest cities in the US, founded in 1636.", "Warwick": "Site of the first blood spilled in the Revolution (Gaspee).", "Cranston": "Consistently ranked as one of America's safest cities.", "Pawtucket": "Birthplace of the American Industrial Revolution.", "Newport": "Famous for Gilded Age mansions and world-class sailing." } },
            "SC": { name: "South Carolina", region: "southeast", capital: "Columbia", cities: { "Columbia": [-81.0348, 34.0007], "Charleston": [-79.9311, 32.7765], "North Charleston": [-79.9733, 32.8546], "Mount Pleasant": [-79.8600, 32.7935], "Rock Hill": [-81.0251, 34.9249] }, facts: { "Columbia": "The state's first planned city, established in 1786.", "Charleston": "The historic heart of the state, famous for its architecture.", "North Charleston": "The industrial center housing Boeing's jet assembly plant.", "Mount Pleasant": "Located across the Cooper River from Charleston.", "Rock Hill": "Old Town hub and major recreational sports center." } },
            "SD": { name: "South Dakota", region: "midwest", capital: "Pierre", cities: { "Pierre": [-100.3508, 44.3683], "Sioux Falls": [-96.7265, 43.5460], "Rapid City": [-103.2310, 44.0805], "Aberdeen": [-98.4842, 45.4647], "Brookings": [-96.7984, 44.3114] }, facts: { "Pierre": "Pronounced 'Peer'; second-smallest US state capital.", "Sioux Falls": "Named for the cataracts of the Big Sioux River.", "Rapid City": "Gateway to the Black Hills and Mount Rushmore.", "Aberdeen": "Where L. Frank Baum lived before writing 'Oz'.", "Brookings": "Home to South Dakota State University." } },
            "TN": { name: "Tennessee", region: "southeast", capital: "Nashville", cities: { "Nashville": [-86.7816, 36.1627], "Memphis": [-90.0490, 35.1495], "Knoxville": [-83.9207, 35.9606], "Chattanooga": [-85.2666, 35.0456], "Clarksville": [-87.3581, 36.5298] }, facts: { "Nashville": "Music City USA; home to the Grand Ole Opry.", "Memphis": "Home of the Blues and Elvis Presley's Graceland.", "Knoxville": "Known for the Sunsphere from the 1982 World's Fair.", "Chattanooga": "The first US city to provide gigabit internet city-wide.", "Clarksville": "Home of the 101st Airborne at Fort Campbell." } },
            "TX": { name: "Texas", region: "southwest", capital: "Austin", cities: { "Austin": [-97.7431, 30.2672], "Houston": [-95.3698, 29.7604], "Dallas": [-96.7970, 32.7767], "San Antonio": [-98.4936, 29.4241], "El Paso": [-106.4850, 31.7619] }, facts: { "Austin": "The Live Music Capital of the World.", "Houston": "Home to the NASA Johnson Space Center.", "Dallas": "The city where the frozen margarita machine was born.", "San Antonio": "Site of the historic Alamo and the River Walk.", "El Paso": "The Sun City, located at the junction of two countries." } },
            "UT": { name: "Utah", region: "western", capital: "Salt Lake City", cities: { "Salt Lake City": [-111.8910, 40.7608], "West Valley City": [-112.0011, 40.6916], "Provo": [-111.6585, 40.2338], "West Jordan": [-111.9391, 40.6097], "Orem": [-111.6946, 40.2969] }, facts: { "Salt Lake City": "Global HQ for the LDS church; hosted the 2002 Olympics.", "West Valley City": "The industrial hub of the Salt Lake Valley.", "Provo": "Home to the massive BYU university campus.", "West Jordan": "Rapidly growing center for the Salt Lake tech corridor.", "Orem": "Known as 'Family City USA'." } },
            "VT": { name: "Vermont", region: "northeast", capital: "Montpelier", cities: { "Montpelier": [-72.5778, 44.2601], "Burlington": [-73.2121, 44.4759], "Rutland": [-72.9726, 43.6106], "Barre": [-72.5012, 44.1970], "Winooski": [-73.1823, 44.4909] }, facts: { "Montpelier": "Smallest US capital; under 8,000 residents.", "Burlington": "The first US city to run on 100% renewable energy.", "Rutland": "Historical center for the Vermont marble industry.", "Barre": "The Granite Capital of the World.", "Winooski": "Known as the 'Onion City' from an Abenaki term." } },
            "VA": { name: "Virginia", region: "southeast", capital: "Richmond", cities: { "Richmond": [-77.4360, 37.5407], "Virginia Beach": [-75.9779, 36.8529], "Norfolk": [-76.2859, 36.8508], "Chesapeake": [-76.2875, 36.7682], "Arlington": [-77.1008, 38.8783] }, facts: { "Richmond": "Capital since 1780; site of Patrick Henry's famous speech.", "Virginia Beach": "World's longest pleasure beach (Guinness Record).", "Norfolk": "Home to the world's largest naval base.", "Chesapeake": "Site of the Great Dismal Swamp National Wildlife Refuge.", "Arlington": "Home to the Pentagon and National Cemetery." } },
            "WA": { name: "Washington", region: "western", capital: "Olympia", cities: { "Olympia": [-122.9007, 47.0379], "Seattle": [-122.3321, 47.6062], "Spokane": [-117.4260, 47.6588], "Tacoma": [-122.4443, 47.2529], "Vancouver": [-122.6615, 45.6387] }, facts: { "Olympia": "Situated at the southern tip of the Puget Sound.", "Seattle": "Emerald City; home to the Space Needle and Starbucks.", "Spokane": "Host city of the 1974 World's Fair.", "Tacoma": "City of Destiny; famous for glass art and its port.", "Vancouver": "Oldest continuously inhabited settlement in WA (1824)." } },
            "WV": { name: "West Virginia", region: "southeast", capital: "Charleston", cities: { "Charleston": [-81.6326, 38.3498], "Huntington": [-82.4451, 38.4193], "Morgantown": [-79.9559, 39.6295], "Parkersburg": [-81.5615, 39.2667], "Wheeling": [-80.7209, 40.0640] }, facts: { "Charleston": "The capitol dome is adorned with real 23-karat gold leaf.", "Huntington": "Home to Marshall University and historic rail hubs.", "Morgantown": "Home to a unique automated Personal Rapid Transit system.", "Parkersburg": "Historic center for the early US oil industry.", "Wheeling": "The state's first capital city." } },
            "WI": { name: "Wisconsin", region: "midwest", capital: "Madison", cities: { "Madison": [-89.4012, 43.0731], "Milwaukee": [-87.9065, 43.0389], "Green Bay": [-88.0198, 44.5192], "Kenosha": [-87.8212, 42.5847], "Racine": [-87.7829, 42.7261] }, facts: { "Madison": "Built on an isthmus between Lakes Mendota and Monona.", "Milwaukee": "Famous for brewing traditions and the Harley-Davidson Museum.", "Green Bay": "Smallest US city to host a major pro sports team (Packers).", "Kenosha": "Known for its vintage streetcars on Lake Michigan.", "Racine": "Birthplace of malted milk and the garbage disposal." } },
            "WY": { name: "Wyoming", region: "western", capital: "Cheyenne", cities: { "Cheyenne": [-104.8202, 41.1400], "Casper": [-106.3252, 42.8666], "Laramie": [-105.5911, 41.3114], "Gillette": [-105.5022, 44.2911], "Rock Springs": [-109.2321, 41.5875] }, facts: { "Cheyenne": "Magic City of the Plains; home to the world's largest outdoor rodeo.", "Casper": "Strategic hub for Wyoming's oil and energy sectors.", "Laramie": "Home to the University of Wyoming, the state's only university.", "Gillette": "The Energy Capital of the Nation for its massive coal reserves.", "Rock Springs": "Known for having residents of 56 different nationalities." } }
        };

        let svg, g, zoom, projection, path;
        let width, height;
        let currentTargetAbbr = "";
        let currentPhase = "MAP_SELECTION"; 
        let score = 0;
        let cityStrikes = 0;
        let visited = new Set();
        let currentScale = 1;

        window.onload = initGame;

        async function initGame() {
            width = window.innerWidth;
            height = window.innerHeight;
            const container = d3.select("#map-stage");
            svg = container.append("svg").attr("viewBox", `0 0 ${width} ${height}`).attr("preserveAspectRatio", "xMidYMid meet");
            g = svg.append("g");
            zoom = d3.zoom().scaleExtent([1, 15]).on("zoom", (e) => {
                g.attr("transform", e.transform);
                currentScale = e.transform.k;
                d3.selectAll(".city-node").attr("r", 6 / currentScale).attr("stroke-width", (2/currentScale));
            });
            svg.call(zoom);

            try {
                const us = await d3.json("https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json");
                const stateFeatures = topojson.feature(us, us.objects.states).features;
                projection = d3.geoAlbersUsa().fitSize([width, height], topojson.feature(us, us.objects.states));
                path = d3.geoPath().projection(projection);

                const nameToAbbr = Object.entries(gameData).reduce((acc, [abbr, data]) => { acc[data.name] = abbr; return acc; }, {});

                g.selectAll("path")
                    .data(stateFeatures)
                    .enter().append("path")
                    .attr("d", path)
                    .attr("class", d => {
                        const abbr = nameToAbbr[d.properties.name];
                        const region = gameData[abbr] ? gameData[abbr].region : "unknown";
                        return `state reg-${region}`;
                    })
                    .attr("id", d => {
                        const abbr = nameToAbbr[d.properties.name];
                        return abbr ? `state-${abbr}` : null;
                    })
                    .on("click", handleStateClick);

                startRound();
            } catch (err) { console.error(err); }
        }

        function startRound() {
            const keys = Object.keys(gameData);
            const available = keys.filter(k => !visited.has(k));
            if (available.length === 0) { alert("Game Complete!"); visited.clear(); score = 0; startRound(); return; }

            currentTargetAbbr = available[Math.floor(Math.random() * available.length)];
            visited.add(currentTargetAbbr);
            
            currentPhase = "MAP_SELECTION";
            cityStrikes = 0;
            resetZoom();
            d3.selectAll(".state").classed("active-focused", false);
            d3.selectAll(".city-node").remove();
            document.getElementById("fact-overlay").classList.remove("show");

            updatePrompt(`Locate ${gameData[currentTargetAbbr].name}`, "Tap the state on the map");
            document.getElementById("target-state").innerText = currentTargetAbbr;
        }

        function handleStateClick(event, d) {
            if (currentPhase !== "MAP_SELECTION") return;
            const clickedId = this.id;
            const clickedAbbr = clickedId ? clickedId.replace("state-", "") : null;

            if (clickedAbbr === currentTargetAbbr) {
                flashState(this, "correct");
                transitionToCityPhase(d, clickedAbbr);
            } else {
                flashState(this, "wrong");
                const wrongName = gameData[clickedAbbr] ? gameData[clickedAbbr].name : "unknown territory";
                updatePrompt("Negative", `That is <span class="wrong-state-highlight">${wrongName}</span>. Try again!`);
            }
        }

        function transitionToCityPhase(geoData, abbr) {
            currentPhase = "CITY_SELECTION";
            zoomToState(geoData);
            d3.select(`#state-${abbr}`).classed("active-focused", true);
            updatePrompt("Strategic Target", `Find the Capital of ${gameData[abbr].name}`);
            plotCities(abbr);

            setTimeout(() => {
                d3.selectAll(".city-node").style("pointer-events", "auto");
            }, 800);
        }

        function plotCities(abbr) {
            const data = gameData[abbr];
            const nodes = Object.entries(data.cities).map(([name, coords]) => {
                const projected = projection(coords);
                return projected ? { name, x: projected[0], y: projected[1] } : null;
            }).filter(n => n);

            g.selectAll(".city-node").data(nodes).enter().append("circle")
                .attr("class", "city-node").attr("cx", d => d.x).attr("cy", d => d.y).attr("r", 0)
                .on("mouseover", showTooltip).on("mousemove", moveTooltip).on("mouseout", hideTooltip)
                .on("click", (e, d) => handleCityClick(e, d, abbr))
                .transition().duration(500).delay(400).attr("r", 6 / currentScale);
        }

        function handleCityClick(event, cityNode, abbr) {
            const data = gameData[abbr];
            const isCorrect = cityNode.name === data.capital;
            const dot = d3.select(event.currentTarget);

            if (isCorrect) {
                dot.classed("correct-choice", true);
                score += (100 - (cityStrikes * 30));
                document.getElementById("score-val").innerText = score;
                showFact(cityNode.name, abbr, "CORRECT", "status-correct");
            } else {
                dot.classed("wrong-choice", true);
                cityStrikes++;
                
                if (cityStrikes >= 3) {
                    showFact(cityNode.name, abbr, "MISSION FAILED", "status-wrong", true);
                } else {
                    showFact(cityNode.name, abbr, "NOT THE CAPITAL", "status-info");
                }
            }
        }

        function showFact(cityName, abbr, status, statusClass, failed = false) {
            const data = gameData[abbr];
            const overlay = document.getElementById("fact-overlay");
            const btn = document.getElementById("next-action-btn");
            
            document.getElementById("fact-status").innerText = status;
            document.getElementById("fact-status").className = `fact-status ${statusClass}`;
            document.getElementById("fact-city-name").innerText = cityName;
            
            let factText = data.facts[cityName] || "No data available for this sector.";
            if (failed) factText += `<br><br>The capital was <b style="color:var(--neon-green)">${data.capital}</b>.`;
            document.getElementById("fact-text").innerHTML = factText;

            btn.innerText = (status === "CORRECT" || failed) ? "Next Mission" : "Try Again";
            btn.onclick = (status === "CORRECT" || failed) ? resetGameRound : () => overlay.classList.remove("show");

            overlay.classList.add("show");
        }

        function showTooltip(e, d) { const tt = document.getElementById("city-tooltip"); tt.innerText = d.name; tt.style.opacity = 1; }
        function moveTooltip(e) { const tt = document.getElementById("city-tooltip"); tt.style.left = e.pageX + "px"; tt.style.top = e.pageY + "px"; }
        function hideTooltip() { document.getElementById("city-tooltip").style.opacity = 0; }
        function resetGameRound() { startRound(); }

        function zoomToState(d) {
            const b = path.bounds(d);
            const s = Math.max(1, Math.min(10, 0.7 / Math.max((b[1][0] - b[0][0]) / width, (b[1][1] - b[0][1]) / height)));
            const t = [width / 2 - s * (b[0][0] + b[1][0]) / 2, height / 2 - s * (b[0][1] + b[1][1]) / 2];
            svg.transition().duration(1000).call(zoom.transform, d3.zoomIdentity.translate(t[0], t[1]).scale(s));
        }

        function resetZoom() { svg.transition().duration(1000).call(zoom.transform, d3.zoomIdentity); }
        function flashState(el, type) { d3.select(el).classed(type+"-flash", true); setTimeout(() => d3.select(el).classed(type+"-flash", false), 500); }
        function updatePrompt(m, s) { document.getElementById("main-prompt").innerHTML = m; document.getElementById("sub-prompt").innerHTML = s; }
    </script>
</body>
</html>
