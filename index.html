<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>US GeoMaster | Tactical Map</title>
    
    <link rel="icon" href="icon_0.jpg" type="image/jpeg">

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson-client@3"></script>
    
    <style>
        :root {
            --bg-deep: #050505;
            --map-base: #151515;
            --map-stroke: #333;
            --neon-blue: #00f3ff;
            --neon-pink: #ff0055;
            --neon-green: #00ff9d;
            --glass: rgba(10, 10, 10, 0.85);
            --font-main: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            margin: 0;
            background-color: var(--bg-deep);
            color: white;
            font-family: var(--font-main);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            user-select: none;
        }

        /* --- MAP LAYER --- */
        #map-stage {
            width: 100%;
            height: 100%;
            cursor: crosshair;
        }

        .state {
            fill: var(--map-base);
            stroke: var(--map-stroke);
            stroke-width: 0.5px;
            transition: fill 0.3s ease;
            vector-effect: non-scaling-stroke;
        }

        .state:hover { fill: #222; }

        .state.active-focused {
            fill: #1a1a1a;
            stroke: #444;
            stroke-width: 1px;
        }

        .state.correct-flash { animation: flashSuccess 0.5s forwards; }
        .state.wrong-flash { animation: flashError 0.5s forwards; }

        @keyframes flashSuccess { 0% { fill: var(--neon-green); } 100% { fill: #1a1a1a; } }
        @keyframes flashError { 0% { fill: var(--neon-pink); } 100% { fill: var(--map-base); } }

        /* --- CITY NODES (The Dots) --- */
        .city-node {
            fill: var(--neon-blue);
            stroke: rgba(0, 243, 255, 0.3);
            stroke-width: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .city-node:hover {
            fill: #fff;
            stroke: var(--neon-blue);
            stroke-width: 15px;
        }

        .city-node.wrong-choice { fill: var(--neon-pink); stroke: var(--neon-pink); }
        .city-node.correct-choice { fill: var(--neon-green); stroke: var(--neon-green); }

        /* --- HUD UI --- */
        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
        }

        #top-hud {
            position: absolute;
            top: 20px; left: 50%;
            transform: translateX(-50%);
            background: var(--glass);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 10px 30px;
            border-radius: 50px;
            display: flex;
            gap: 20px;
            backdrop-filter: blur(5px);
            z-index: 10;
        }

        .hud-item { font-size: 0.9rem; color: #aaa; text-transform: uppercase; letter-spacing: 1px; }
        .hud-val { color: var(--neon-blue); font-weight: bold; margin-left: 5px; }

        /* Center Prompts */
        #prompt-container {
            position: absolute;
            top: 15%; width: 100%;
            text-align: center;
            pointer-events: none;
            text-shadow: 0 5px 20px black;
        }

        #main-prompt {
            font-size: 2.5rem;
            font-weight: 900;
            text-transform: uppercase;
            margin: 0;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s ease;
        }
        #main-prompt.visible { opacity: 1; transform: translateY(0); }
        
        #sub-prompt {
            font-size: 1.1rem;
            color: var(--neon-blue);
            margin-top: 5px;
            letter-spacing: 1px;
        }

        /* Tooltip for City Hover */
        #city-tooltip {
            position: absolute;
            background: rgba(0,0,0,0.9);
            border: 1px solid var(--neon-blue);
            color: white;
            padding: 8px 15px;
            border-radius: 4px;
            font-size: 0.9rem;
            pointer-events: none;
            opacity: 0;
            transform: translate(-50%, -150%); /* Center above cursor */
            white-space: nowrap;
            z-index: 50;
            transition: opacity 0.2s;
            box-shadow: 0 0 15px var(--neon-blue);
        }

        /* Modal Overlay for Facts */
        #fact-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(8px);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        #fact-overlay.show { opacity: 1; pointer-events: auto; }

        .fact-card {
            background: #111;
            border: 1px solid var(--neon-blue);
            border-radius: 12px;
            padding: 40px;
            max-width: 450px;
            width: 90%;
            text-align: center;
            box-shadow: 0 0 50px rgba(0, 243, 255, 0.1);
        }

        .fact-status { font-weight: 800; letter-spacing: 2px; margin-bottom: 15px; font-size: 1.2rem; }
        .status-correct { color: var(--neon-green); }
        .status-wrong { color: var(--neon-pink); }
        
        .fact-city { font-size: 2rem; margin: 0 0 15px; color: white; }
        .fact-body { color: #ccc; line-height: 1.6; margin-bottom: 25px; font-size: 1rem; }

        .next-btn {
            background: var(--neon-blue);
            color: #000;
            border: none;
            padding: 12px 30px;
            font-weight: 700;
            border-radius: 30px;
            cursor: pointer;
            box-shadow: 0 0 15px var(--neon-blue);
        }
        .next-btn:hover { transform: scale(1.05); background: white; }

        /* Loader */
        #loading {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%,-50%);
            letter-spacing: 3px; font-size: 1.2rem;
            animation: pulse 1s infinite;
        }
        @keyframes pulse { 0% {opacity:0.5;} 50% {opacity:1;} 100% {opacity:0.5;} }

    </style>
</head>
<body>

    <div id="loading">INITIALIZING SATELLITE DATA...</div>

    <div id="city-tooltip">City Name</div>

    <div id="map-stage"></div>

    <div id="ui-layer">
        <div id="top-hud">
            <div><span class="hud-item">Target</span> <span id="target-state" class="hud-val">---</span></div>
            <div><span class="hud-item">Score</span> <span id="score-val" class="hud-val">0</span></div>
        </div>

        <div id="prompt-container">
            <h1 id="main-prompt" class="visible"></h1>
            <div id="sub-prompt"></div>
        </div>
    </div>

    <div id="fact-overlay">
        <div class="fact-card">
            <div class="fact-status" id="fact-status">Correct</div>
            <div class="fact-city" id="fact-city-name">City</div>
            <div class="fact-body" id="fact-text">Fact goes here.</div>
            <button class="next-btn" onclick="resetGameRound()">Next Mission</button>
        </div>
    </div>

    <script>
        // --- COMPLETE 50 STATE DATASET ---
        const gameData = {
            "AL": { name: "Alabama", capital: "Montgomery", cities: { "Montgomery": [-86.3077, 32.3792], "Birmingham": [-86.8104, 33.5186], "Mobile": [-88.0399, 30.6954], "Huntsville": [-86.5861, 34.7304], "Tuscaloosa": [-87.5692, 33.2098] }, facts: { "Montgomery": "The birthplace of the Civil Rights Movement.", "Birmingham": "Founded at the crossing of two major railroads.", "Huntsville": "Home to the U.S. Space & Rocket Center." } },
            "AK": { name: "Alaska", capital: "Juneau", cities: { "Juneau": [-134.4197, 58.3019], "Anchorage": [-149.9003, 61.2181], "Fairbanks": [-147.7164, 64.8378], "Sitka": [-135.3300, 57.0531], "Ketchikan": [-131.6461, 55.3422] }, facts: { "Juneau": "No roads connect Juneau to the rest of Alaska.", "Anchorage": "Contains nearly 40% of the state's population.", "Fairbanks": "Famous for the Aurora Borealis." } },
            "AZ": { name: "Arizona", capital: "Phoenix", cities: { "Phoenix": [-112.0740, 33.4484], "Tucson": [-110.9747, 32.2226], "Mesa": [-111.8315, 33.4152], "Scottsdale": [-111.9261, 33.4942], "Flagstaff": [-111.6513, 35.1983] }, facts: { "Phoenix": "The most populous state capital in the US.", "Flagstaff": "A gateway to the San Francisco Peaks and Grand Canyon.", "Tucson": "Home to the University of Arizona." } },
            "AR": { name: "Arkansas", capital: "Little Rock", cities: { "Little Rock": [-92.2896, 34.7465], "Fayetteville": [-94.1574, 36.0626], "Fort Smith": [-94.4229, 35.3859], "Springdale": [-94.1288, 36.1867], "Hot Springs": [-93.0552, 34.5037] }, facts: { "Little Rock": "Named for a small rock formation on the river.", "Hot Springs": "Childhood home of President Bill Clinton." } },
            "CA": { name: "California", capital: "Sacramento", cities: { "Sacramento": [-121.4944, 38.5816], "Los Angeles": [-118.2437, 34.0522], "San Francisco": [-122.4194, 37.7749], "San Diego": [-117.1611, 32.7157], "Fresno": [-119.7871, 36.7378] }, facts: { "Sacramento": "Became the capital in 1854.", "San Francisco": "Famous for the Golden Gate Bridge and fog.", "Los Angeles": "The center of the nation's film industry." } },
            "CO": { name: "Colorado", capital: "Denver", cities: { "Denver": [-104.9903, 39.7392], "Colorado Springs": [-104.8214, 38.8339], "Aurora": [-104.8319, 39.7294], "Fort Collins": [-105.0844, 40.5853], "Boulder": [-105.2705, 40.0150] }, facts: { "Denver": "Exactly one mile (5280 ft) above sea level.", "Colorado Springs": "Home to the US Air Force Academy." } },
            "CT": { name: "Connecticut", capital: "Hartford", cities: { "Hartford": [-72.6734, 41.7658], "Bridgeport": [-73.1894, 41.1792], "New Haven": [-72.9279, 41.3083], "Stamford": [-73.5387, 41.0534], "Waterbury": [-73.0454, 41.5582] }, facts: { "Hartford": "Known as the Insurance Capital of the World.", "New Haven": "Home to Yale University." } },
            "DE": { name: "Delaware", capital: "Dover", cities: { "Dover": [-75.5297, 39.1582], "Wilmington": [-75.5484, 39.7447], "Newark": [-75.7497, 39.6837], "Middletown": [-75.7163, 39.4496], "Rehoboth Beach": [-75.0760, 38.7209] }, facts: { "Dover": "Home to a major Air Force base and speedway.", "Wilmington": "A national hub for credit card companies." } },
            "FL": { name: "Florida", capital: "Tallahassee", cities: { "Tallahassee": [-84.2807, 30.4383], "Miami": [-80.1918, 25.7617], "Orlando": [-81.3792, 28.5383], "Tampa": [-82.4572, 27.9506], "Jacksonville": [-81.6557, 30.3322] }, facts: { "Tallahassee": "Site of the first Christmas celebration in the US.", "Orlando": "Theme park capital of the world.", "Miami": "Known as the 'Magic City'." } },
            "GA": { name: "Georgia", capital: "Atlanta", cities: { "Atlanta": [-84.3880, 33.7490], "Savannah": [-81.0998, 32.0809], "Augusta": [-81.9748, 33.4735], "Macon": [-83.6324, 32.8407], "Athens": [-83.3576, 33.9519] }, facts: { "Atlanta": "Hosted the 1996 Summer Olympics.", "Savannah": "Known for its historic city squares and weeping willows." } },
            "HI": { name: "Hawaii", capital: "Honolulu", cities: { "Honolulu": [-157.8583, 21.3069], "Hilo": [-155.0844, 19.7297], "Kailua": [-157.7394, 21.4022], "Kahului": [-156.4729, 20.8893], "Lihue": [-159.3711, 21.9811] }, facts: { "Honolulu": "Home to Iolani Palace, the only royal palace in the US.", "Hilo": "Known for its waterfalls and rainforests." } },
            "ID": { name: "Idaho", capital: "Boise", cities: { "Boise": [-116.2023, 43.6150], "Meridian": [-116.3915, 43.6121], "Nampa": [-116.5635, 43.5407], "Idaho Falls": [-112.0340, 43.4917], "Pocatello": [-112.4506, 42.8666] }, facts: { "Boise": "Called the 'City of Trees'.", "Idaho Falls": "Powered by a hydroelectric plant on the Snake River." } },
            "IL": { name: "Illinois", capital: "Springfield", cities: { "Springfield": [-89.6501, 39.7817], "Chicago": [-87.6298, 41.8781], "Aurora": [-88.3156, 41.7606], "Rockford": [-89.0939, 42.2711], "Peoria": [-89.5890, 40.6936] }, facts: { "Springfield": "Abraham Lincoln lived here for 17 years.", "Chicago": "Invented the modern skyscraper." } },
            "IN": { name: "Indiana", capital: "Indianapolis", cities: { "Indianapolis": [-86.1581, 39.7684], "Fort Wayne": [-85.1394, 41.0793], "Evansville": [-87.5711, 37.9716], "South Bend": [-86.2520, 41.6764], "Carmel": [-86.1180, 39.9784] }, facts: { "Indianapolis": "Home of the Indy 500.", "South Bend": "Home to the University of Notre Dame." } },
            "IA": { name: "Iowa", capital: "Des Moines", cities: { "Des Moines": [-93.6091, 41.6005], "Cedar Rapids": [-91.6656, 41.9779], "Davenport": [-90.5776, 41.5236], "Sioux City": [-96.4103, 42.4999], "Iowa City": [-91.5302, 41.6611] }, facts: { "Des Moines": "A major hub for the insurance industry.", "Iowa City": "A UNESCO City of Literature." } },
            "KS": { name: "Kansas", capital: "Topeka", cities: { "Topeka": [-95.6890, 39.0473], "Wichita": [-97.3301, 37.6872], "Overland Park": [-94.6708, 38.9822], "Kansas City": [-94.6274, 39.1140], "Lawrence": [-95.2353, 38.9717] }, facts: { "Topeka": "The name means 'a good place to dig potatoes'.", "Wichita": "Known as the 'Air Capital of the World'." } },
            "KY": { name: "Kentucky", capital: "Frankfort", cities: { "Frankfort": [-84.8705, 38.2009], "Louisville": [-85.7585, 38.2527], "Lexington": [-84.5037, 38.0406], "Bowling Green": [-86.4436, 36.9685], "Owensboro": [-87.1181, 37.7719] }, facts: { "Frankfort": "Divided by the Kentucky River.", "Louisville": "Home of the Kentucky Derby and Louisville Slugger." } },
            "LA": { name: "Louisiana", capital: "Baton Rouge", cities: { "Baton Rouge": [-91.1403, 30.4583], "New Orleans": [-90.0715, 29.9511], "Shreveport": [-93.7502, 32.5252], "Lafayette": [-92.0198, 30.2241], "Lake Charles": [-93.2174, 30.2265] }, facts: { "Baton Rouge": "French for 'Red Stick'.", "New Orleans": "Famous for Mardi Gras and jazz music." } },
            "ME": { name: "Maine", capital: "Augusta", cities: { "Augusta": [-69.7795, 44.3106], "Portland": [-70.2568, 43.6591], "Lewiston": [-70.2148, 44.1004], "Bangor": [-68.7778, 44.8016], "Bar Harbor": [-68.2039, 44.3876] }, facts: { "Augusta": "The easternmost state capital.", "Portland": "Maine's economic and cultural hub." } },
            "MD": { name: "Maryland", capital: "Annapolis", cities: { "Annapolis": [-76.4922, 38.9784], "Baltimore": [-76.6122, 39.2904], "Frederick": [-77.4105, 39.4143], "Rockville": [-77.1528, 39.0840], "Ocean City": [-75.0849, 38.3365] }, facts: { "Annapolis": "Known as the 'Sailing Capital of the World'.", "Baltimore": "Home of the 'Star-Spangled Banner'." } },
            "MA": { name: "Massachusetts", capital: "Boston", cities: { "Boston": [-71.0589, 42.3601], "Worcester": [-71.8023, 42.2626], "Springfield": [-72.5898, 42.1015], "Cambridge": [-71.1097, 42.3736], "Salem": [-70.8959, 42.5195] }, facts: { "Boston": "One of the oldest municipalities in the US.", "Cambridge": "Home to Harvard University and MIT." } },
            "MI": { name: "Michigan", capital: "Lansing", cities: { "Lansing": [-84.5555, 42.7325], "Detroit": [-83.0458, 42.3314], "Grand Rapids": [-85.6681, 42.9634], "Ann Arbor": [-83.7430, 42.2808], "Traverse City": [-85.6206, 44.7631] }, facts: { "Lansing": "The only state capital located in a township of the same name.", "Detroit": "Known as the 'Motor City'." } },
            "MN": { name: "Minnesota", capital: "Saint Paul", cities: { "Saint Paul": [-93.0899, 44.9537], "Minneapolis": [-93.2650, 44.9778], "Rochester": [-92.4802, 44.0121], "Duluth": [-92.1005, 46.7867], "Bloomington": [-93.2983, 44.8408] }, facts: { "Saint Paul": "Forms the 'Twin Cities' with Minneapolis.", "Minneapolis": "Famous for the Mall of America nearby." } },
            "MS": { name: "Mississippi", capital: "Jackson", cities: { "Jackson": [-90.1848, 32.2988], "Gulfport": [-89.0928, 30.3674], "Biloxi": [-88.8853, 30.3960], "Hattiesburg": [-89.2903, 31.3271], "Tupelo": [-88.7034, 34.2576] }, facts: { "Jackson": "Sits atop an extinct volcano.", "Biloxi": "A major center of the seafood industry." } },
            "MO": { name: "Missouri", capital: "Jefferson City", cities: { "Jefferson City": [-92.1735, 38.5767], "Kansas City": [-94.5786, 39.0997], "St. Louis": [-90.1994, 38.6270], "Springfield": [-93.2923, 37.2089], "Branson": [-93.2185, 36.6437] }, facts: { "Jefferson City": "Named after Thomas Jefferson.", "St. Louis": "The Gateway Arch is the world's tallest arch." } },
            "MT": { name: "Montana", capital: "Helena", cities: { "Helena": [-112.0270, 46.5891], "Billings": [-108.5007, 45.7833], "Missoula": [-113.9966, 46.8721], "Great Falls": [-111.3218, 47.5053], "Bozeman": [-111.0429, 45.6770] }, facts: { "Helena": "Founded by gold miners in 1864.", "Bozeman": "Gateway to Yellowstone National Park." } },
            "NE": { name: "Nebraska", capital: "Lincoln", cities: { "Lincoln": [-96.7026, 40.8136], "Omaha": [-95.9345, 41.2565], "Bellevue": [-95.9403, 41.1578], "Grand Island": [-98.3414, 40.9264], "Kearney": [-99.0817, 40.6995] }, facts: { "Lincoln": "Home to the only unicameral legislature in the US.", "Omaha": "Home of billionaire Warren Buffett." } },
            "NV": { name: "Nevada", capital: "Carson City", cities: { "Carson City": [-119.7674, 39.1638], "Las Vegas": [-115.1398, 36.1699], "Henderson": [-114.9817, 36.0395], "Reno": [-119.8138, 39.5296], "Elko": [-115.7631, 40.8324] }, facts: { "Carson City": "One of the smallest state capitals.", "Las Vegas": "The brightest spot on Earth from space." } },
            "NH": { name: "New Hampshire", capital: "Concord", cities: { "Concord": [-71.5376, 43.2081], "Manchester": [-71.4548, 42.9956], "Nashua": [-71.4676, 42.7654], "Dover": [-70.8737, 43.1979], "Portsmouth": [-70.7626, 43.0718] }, facts: { "Concord": "Famous for its granite quarries.", "Manchester": "A major textile manufacturing center in the 19th century." } },
            "NJ": { name: "New Jersey", capital: "Trenton", cities: { "Trenton": [-74.7429, 40.2206], "Newark": [-74.1724, 40.7357], "Jersey City": [-74.0431, 40.7178], "Paterson": [-74.1718, 40.9168], "Atlantic City": [-74.4229, 39.3643] }, facts: { "Trenton": "Site of George Washington's first military victory.", "Atlantic City": "Inspiration for the game Monopoly." } },
            "NM": { name: "New Mexico", capital: "Santa Fe", cities: { "Santa Fe": [-105.9378, 35.6870], "Albuquerque": [-106.6056, 35.0844], "Las Cruces": [-106.7785, 32.3199], "Rio Rancho": [-106.6622, 35.2328], "Roswell": [-104.5230, 33.3943] }, facts: { "Santa Fe": "The highest state capital in the US (7,199 ft).", "Roswell": "Famous for the 1947 UFO incident." } },
            "NY": { name: "New York", capital: "Albany", cities: { "Albany": [-73.7562, 42.6526], "New York City": [-74.0060, 40.7128], "Buffalo": [-78.8784, 42.8864], "Rochester": [-77.6109, 43.1610], "Syracuse": [-76.1474, 43.0481] }, facts: { "Albany": "One of the oldest surviving settlements in the US.", "New York City": "The financial capital of the world." } },
            "NC": { name: "North Carolina", capital: "Raleigh", cities: { "Raleigh": [-78.6382, 35.7796], "Charlotte": [-80.8431, 35.2271], "Greensboro": [-79.7920, 36.0726], "Durham": [-78.8986, 35.9940], "Asheville": [-82.5515, 35.5951] }, facts: { "Raleigh": "Known as the 'City of Oaks'.", "Charlotte": "A major banking hub and home to NASCAR." } },
            "ND": { name: "North Dakota", capital: "Bismarck", cities: { "Bismarck": [-100.7837, 46.8083], "Fargo": [-96.7898, 46.8772], "Grand Forks": [-97.0329, 47.9253], "Minot": [-101.2963, 48.2325], "Williston": [-103.6256, 48.1470] }, facts: { "Bismarck": "Named after German Chancellor Otto von Bismarck.", "Fargo": "The largest city in North Dakota." } },
            "OH": { name: "Ohio", capital: "Columbus", cities: { "Columbus": [-82.9988, 39.9612], "Cleveland": [-81.6944, 41.4993], "Cincinnati": [-84.5120, 39.1031], "Toledo": [-83.5552, 41.6528], "Dayton": [-84.1916, 39.7589] }, facts: { "Columbus": "Home to The Ohio State University.", "Cleveland": "Home to the Rock and Roll Hall of Fame." } },
            "OK": { name: "Oklahoma", capital: "Oklahoma City", cities: { "Oklahoma City": [-97.5164, 35.4676], "Tulsa": [-95.9928, 36.1540], "Norman": [-97.4395, 35.2226], "Broken Arrow": [-95.7908, 36.0526], "Lawton": [-98.3903, 34.6036] }, facts: { "Oklahoma City": "Founded during the Land Run of 1889.", "Tulsa": "Once known as the 'Oil Capital of the World'." } },
            "OR": { name: "Oregon", capital: "Salem", cities: { "Salem": [-123.0351, 44.9429], "Portland": [-122.6784, 45.5152], "Eugene": [-123.0868, 44.0521], "Bend": [-121.3153, 44.0582], "Medford": [-122.8752, 42.3265] }, facts: { "Salem": "The state capitol is topped by a golden pioneer.", "Portland": "Famous for its bridges, parks, and donuts." } },
            "PA": { name: "Pennsylvania", capital: "Harrisburg", cities: { "Harrisburg": [-76.8867, 40.2732], "Philadelphia": [-75.1652, 39.9526], "Pittsburgh": [-79.9959, 40.4406], "Allentown": [-75.4902, 40.6023], "Erie": [-80.0850, 42.1292] }, facts: { "Harrisburg": "Played a key role in the Civil War/Underground Railroad.", "Philadelphia": "The birthplace of the United States." } },
            "RI": { name: "Rhode Island", capital: "Providence", cities: { "Providence": [-71.4128, 41.8240], "Warwick": [-71.4162, 41.7001], "Cranston": [-71.4406, 41.7798], "Pawtucket": [-71.3824, 41.8787], "Newport": [-71.3128, 41.4901] }, facts: { "Providence": "Founded by Roger Williams in 1636.", "Newport": "Famous for its Gilded Age mansions." } },
            "SC": { name: "South Carolina", capital: "Columbia", cities: { "Columbia": [-81.0348, 34.0007], "Charleston": [-79.9311, 32.7765], "North Charleston": [-79.9733, 32.8546], "Mount Pleasant": [-79.8600, 32.7935], "Greenville": [-82.3940, 34.8526] }, facts: { "Columbia": "The first planned city in the US.", "Charleston": "Where the first shots of the Civil War were fired." } },
            "SD": { name: "South Dakota", capital: "Pierre", cities: { "Pierre": [-100.3508, 44.3683], "Sioux Falls": [-96.7265, 43.5460], "Rapid City": [-103.2310, 44.0805], "Aberdeen": [-98.4842, 45.4647], "Deadwood": [-103.7296, 44.3767] }, facts: { "Pierre": "Pronounced 'Peer', it's the second smallest capital.", "Rapid City": "Gateway to Mount Rushmore." } },
            "TN": { name: "Tennessee", capital: "Nashville", cities: { "Nashville": [-86.7816, 36.1627], "Memphis": [-90.0490, 35.1495], "Knoxville": [-83.9207, 35.9606], "Chattanooga": [-85.2666, 35.0456], "Gatlinburg": [-83.5102, 35.7143] }, facts: { "Nashville": "Known worldwide as Music City.", "Memphis": "Home to Graceland and the blues." } },
            "TX": { name: "Texas", capital: "Austin", cities: { "Austin": [-97.7431, 30.2672], "Houston": [-95.3698, 29.7604], "Dallas": [-96.7970, 32.7767], "San Antonio": [-98.4936, 29.4241], "El Paso": [-106.4850, 31.7619] }, facts: { "Austin": "Known as the Live Music Capital of the World.", "Houston": "Home to NASA Mission Control." } },
            "UT": { name: "Utah", capital: "Salt Lake City", cities: { "Salt Lake City": [-111.8910, 40.7608], "West Valley City": [-112.0011, 40.6916], "Provo": [-111.6585, 40.2338], "West Jordan": [-111.9391, 40.6097], "Park City": [-111.4980, 40.6461] }, facts: { "Salt Lake City": "Founded by Mormon pioneers in 1847.", "Park City": "Host of the Sundance Film Festival." } },
            "VT": { name: "Vermont", capital: "Montpelier", cities: { "Montpelier": [-72.5778, 44.2601], "Burlington": [-73.2121, 44.4759], "Rutland": [-72.9726, 43.6106], "Barre": [-72.5012, 44.1970], "Stowe": [-72.6918, 44.4654] }, facts: { "Montpelier": "The smallest state capital by population.", "Burlington": "Vermont's largest city, located on Lake Champlain." } },
            "VA": { name: "Virginia", capital: "Richmond", cities: { "Richmond": [-77.4360, 37.5407], "Virginia Beach": [-75.9779, 36.8529], "Norfolk": [-76.2859, 36.8508], "Chesapeake": [-76.2875, 36.7682], "Arlington": [-77.1008, 38.8783] }, facts: { "Richmond": "Capital of the Confederacy during the Civil War.", "Arlington": "Home to the Pentagon and Arlington National Cemetery." } },
            "WA": { name: "Washington", capital: "Olympia", cities: { "Olympia": [-122.9007, 47.0379], "Seattle": [-122.3321, 47.6062], "Spokane": [-117.4260, 47.6588], "Tacoma": [-122.4443, 47.2529], "Vancouver": [-122.6615, 45.6387] }, facts: { "Olympia": "Located at the southern end of Puget Sound.", "Seattle": "Home of Starbucks, Amazon, and the Space Needle." } },
            "WV": { name: "West Virginia", capital: "Charleston", cities: { "Charleston": [-81.6326, 38.3498], "Huntington": [-82.4451, 38.4193], "Morgantown": [-79.9559, 39.6295], "Parkersburg": [-81.5615, 39.2667], "Wheeling": [-80.7209, 40.0640] }, facts: { "Charleston": "The golden dome of the capitol is real gold leaf.", "Morgantown": "Home to West Virginia University." } },
            "WI": { name: "Wisconsin", capital: "Madison", cities: { "Madison": [-89.4012, 43.0731], "Milwaukee": [-87.9065, 43.0389], "Green Bay": [-88.0198, 44.5192], "Kenosha": [-87.8212, 42.5847], "Racine": [-87.7829, 42.7261] }, facts: { "Madison": "Built on an isthmus between two lakes.", "Green Bay": "Home to the Packers, the only community-owned NFL team." } },
            "WY": { name: "Wyoming", capital: "Cheyenne", cities: { "Cheyenne": [-104.8202, 41.1400], "Casper": [-106.3252, 42.8666], "Laramie": [-105.5911, 41.3114], "Gillette": [-105.5022, 44.2911], "Jackson": [-110.7624, 43.4799] }, facts: { "Cheyenne": "Named for the Cheyenne Native American nation.", "Jackson": "Gateway to Grand Teton and Yellowstone National Parks." } }
        };

        // Fallback fact generator
        function getFact(city, stateData) {
            if (stateData.facts && stateData.facts[city]) return stateData.facts[city];
            if (city === stateData.capital) return `It serves as the political heart of ${stateData.name}.`;
            return `A major economic and cultural hub in ${stateData.name}.`;
        }

        // --- GLOBAL VARIABLES ---
        let svg, g, zoom, projection, path;
        let width, height;
        let currentTargetAbbr = "";
        let currentPhase = "MAP_SELECTION"; 
        let score = 0;
        let visited = new Set();
        let currentScale = 1;

        // --- INITIALIZATION ---
        window.onload = initGame;
        window.onresize = handleResize;

        async function initGame() {
            width = window.innerWidth;
            height = window.innerHeight;

            const container = d3.select("#map-stage");
            svg = container.append("svg")
                .attr("viewBox", `0 0 ${width} ${height}`)
                .attr("preserveAspectRatio", "xMidYMid meet");
            
            g = svg.append("g");

            // Setup Zoom
            zoom = d3.zoom()
                .scaleExtent([1, 12])
                .on("zoom", (e) => {
                    g.attr("transform", e.transform);
                    currentScale = e.transform.k;
                    // Keep city dots consistent size while zooming
                    d3.selectAll(".city-node").attr("r", 6 / currentScale).attr("stroke-width", (2/currentScale));
                });
            svg.call(zoom);

            try {
                const us = await d3.json("https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json");
                const stateFeatures = topojson.feature(us, us.objects.states).features;

                projection = d3.geoAlbersUsa().fitSize([width, height], topojson.feature(us, us.objects.states));
                path = d3.geoPath().projection(projection);

                const nameToAbbr = Object.entries(gameData).reduce((acc, [abbr, data]) => {
                    acc[data.name] = abbr;
                    return acc;
                }, {});

                g.selectAll("path")
                    .data(stateFeatures)
                    .enter().append("path")
                    .attr("d", path)
                    .attr("class", "state")
                    .attr("id", d => {
                        const abbr = nameToAbbr[d.properties.name];
                        return abbr ? `state-${abbr}` : null;
                    })
                    .on("click", handleStateClick);

                // Remove loader
                d3.select("#loading").remove();
                
                startRound();

            } catch (err) {
                console.error(err);
                d3.select("#loading").text("Error Loading Map Data");
            }
        }

        function handleResize() {
            width = window.innerWidth;
            height = window.innerHeight;
            d3.select("svg").attr("viewBox", `0 0 ${width} ${height}`);
        }

        // --- GAME LOGIC ---

        function startRound() {
            // Find unvisited states
            const keys = Object.keys(gameData);
            const available = keys.filter(k => !visited.has(k));
            
            if (available.length === 0) {
                alert("Mission Complete! Resetting...");
                visited.clear();
                score = 0;
                document.getElementById("score-val").innerText = score;
                startRound();
                return;
            }

            currentTargetAbbr = available[Math.floor(Math.random() * available.length)];
            visited.add(currentTargetAbbr);
            const targetName = gameData[currentTargetAbbr].name;

            // Reset UI
            currentPhase = "MAP_SELECTION";
            resetZoom();
            d3.selectAll(".state").classed("active-focused", false);
            d3.selectAll(".city-node").remove(); 
            document.getElementById("fact-overlay").classList.remove("show");

            updatePrompt(`Locate ${targetName}`, "Select the state on the map");
            document.getElementById("target-state").innerText = targetName;
        }

        function handleStateClick(event, d) {
            const clickedId = this.id; 
            const clickedAbbr = clickedId ? clickedId.replace("state-", "") : null;

            if (!clickedAbbr || !gameData[clickedAbbr]) return; 

            if (currentPhase === "MAP_SELECTION") {
                if (clickedAbbr === currentTargetAbbr) {
                    flashState(this, "correct");
                    transitionToCityPhase(d, clickedAbbr);
                } else {
                    flashState(this, "wrong");
                    updatePrompt("Negative", "Try again");
                }
            }
        }

        function transitionToCityPhase(geoData, abbr) {
            currentPhase = "CITY_SELECTION";
            
            // 1. Zoom to State
            zoomToState(geoData);
            d3.select(`#state-${abbr}`).classed("active-focused", true);

            // 2. Update UI
            updatePrompt("Identify Capital", "Hover to scan, Click to select");

            // 3. Plot Cities
            plotCities(abbr);
        }

        function plotCities(abbr) {
            const data = gameData[abbr];
            const cityEntries = Object.entries(data.cities);

            const nodes = cityEntries.map(([name, coords]) => {
                const projected = projection(coords);
                // Handle cases where projection returns null (outside bounds)
                return projected ? { name, x: projected[0], y: projected[1] } : null;
            }).filter(n => n);

            g.selectAll(".city-node")
                .data(nodes)
                .enter().append("circle")
                .attr("class", "city-node")
                .attr("cx", d => d.x)
                .attr("cy", d => d.y)
                .attr("r", 0) 
                .on("mouseover", showTooltip)
                .on("mousemove", moveTooltip)
                .on("mouseout", hideTooltip)
                .on("click", (e, d) => handleCityClick(d, abbr))
                .transition().duration(500).delay(300)
                .attr("r", 6 / currentScale); 
        }

        function handleCityClick(cityNode, abbr) {
            const data = gameData[abbr];
            const isCorrect = cityNode.name === data.capital;
            
            // Visual feedback on the dot
            const dot = d3.select(event.currentTarget);
            dot.classed(isCorrect ? "correct-choice" : "wrong-choice", true);

            if (isCorrect) {
                score += 100;
                document.getElementById("score-val").innerText = score;
            }

            // Show Fact Modal
            setTimeout(() => {
                showFact(cityNode.name, abbr, isCorrect);
            }, 400);
        }

        // --- UI HELPERS ---

        function showTooltip(event, d) {
            const tt = document.getElementById("city-tooltip");
            tt.innerText = d.name;
            tt.style.opacity = 1;
        }

        function moveTooltip(event) {
            const tt = document.getElementById("city-tooltip");
            tt.style.left = event.pageX + "px";
            tt.style.top = event.pageY + "px";
        }

        function hideTooltip() {
            document.getElementById("city-tooltip").style.opacity = 0;
        }

        function showFact(cityName, abbr, isCorrect) {
            const data = gameData[abbr];
            const overlay = document.getElementById("fact-overlay");
            const statusEl = document.getElementById("fact-status");
            const bodyEl = document.getElementById("fact-text");
            
            document.getElementById("fact-city-name").innerText = cityName;

            if (isCorrect) {
                statusEl.innerText = "ACCESS GRANTED";
                statusEl.className = "fact-status status-correct";
                bodyEl.innerHTML = `${getFact(cityName, data)}`;
            } else {
                statusEl.innerText = "INCORRECT TARGET";
                statusEl.className = "fact-status status-wrong";
                bodyEl.innerHTML = `You selected ${cityName}.<br><br>The capital is <strong style="color:var(--neon-green)">${data.capital}</strong>.`;
            }

            overlay.classList.add("show");
        }

        function resetGameRound() {
            startRound();
        }

        // --- ZOOM & ANIMATION ---

        function zoomToState(d) {
            const bounds = path.bounds(d);
            const dx = bounds[1][0] - bounds[0][0];
            const dy = bounds[1][1] - bounds[0][1];
            const x = (bounds[0][0] + bounds[1][0]) / 2;
            const y = (bounds[0][1] + bounds[1][1]) / 2;
            
            const scale = Math.max(1, Math.min(8, 0.6 / Math.max(dx / width, dy / height)));
            const translate = [width / 2 - scale * x, height / 2 - scale * y];

            svg.transition()
                .duration(1000)
                .call( zoom.transform, d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale) );
        }

        function resetZoom() {
            svg.transition().duration(1000).call( zoom.transform, d3.zoomIdentity );
        }

        function flashState(element, type) {
            const className = type === "correct" ? "correct-flash" : "wrong-flash";
            d3.select(element).classed(className, true);
            setTimeout(() => {
                d3.select(element).classed(className, false);
            }, 500);
        }

        function updatePrompt(main, sub) {
            const mainEl = document.getElementById("main-prompt");
            const subEl = document.getElementById("sub-prompt");
            mainEl.classList.remove("visible");
            setTimeout(() => {
                mainEl.innerText = main;
                subEl.innerText = sub;
                mainEl.classList.add("visible");
            }, 200);
        }

    </script>
</body>
</html>
