<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <title>Maps Quiz</title>

    <link rel="icon" href="us_icon.png" type="image/png" />
    <link rel="apple-touch-icon" href="us_icon.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson-client@3"></script>

    <script src="data.js"></script>

    <style>
      :root {
        --bg-deep: #002d59;
        --map-stroke: rgba(0, 0, 0, 0.15);
        --neon-blue: #00f3ff;
        --neon-pink: #ff0055;
        --neon-green: #00ff9d;
        --neon-amber: #ffaa00;
        --glass: rgba(15, 15, 15, 0.85);
        --font-main: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;

        --c-southwest: #ff9999;
        --c-western: #99ff99;
        --c-northeast: #99ccff;
        --c-midwest: #ffcc99;
        --c-southeast: #d2b48c;
      }

      body {
        margin: 0;
        background-color: var(--bg-deep);
        color: white;
        font-family: var(--font-main);
        overflow: hidden;
        height: 100vh;
        width: 100vw;
        user-select: none;
        touch-action: none;
        padding-top: 40px;
        box-sizing: border-box;
      }

      #map-stage {
        width: 100%;
        height: calc(100% - 40px);
        cursor: crosshair;
      }

      .state {
        stroke: var(--map-stroke);
        stroke-width: 0.5px;
        transition:
          fill 0.3s,
          opacity 0.3s;
        vector-effect: non-scaling-stroke;
      }
      .reg-southwest {
        fill: var(--c-southwest);
      }
      .reg-western {
        fill: var(--c-western);
      }
      .reg-northeast {
        fill: var(--c-northeast);
      }
      .reg-midwest {
        fill: var(--c-midwest);
      }
      .reg-southeast {
        fill: var(--c-southeast);
      }

      .state:hover {
        opacity: 0.8;
        stroke: rgba(255, 255, 255, 0.4);
      }
      .state.active-focused {
        opacity: 1;
        stroke: #fff;
        stroke-width: 2px;
      }

      .state.correct-flash {
        animation: flashSuccess 0.5s forwards;
      }
      .state.wrong-flash {
        animation: flashError 0.5s forwards;
      }
      @keyframes flashSuccess {
        0% {
          fill: var(--neon-green);
          opacity: 1;
        }
        100% {
          fill: inherit;
          opacity: 0.25;
        }
      }
      @keyframes flashError {
        0% {
          fill: var(--neon-pink);
          opacity: 1;
        }
        100% {
          fill: inherit;
          opacity: 0.25;
        }
      }

      .city-node {
        fill: var(--neon-blue);
        stroke: rgba(0, 243, 255, 0.2);
        stroke-width: 5px;
        cursor: pointer;
        transition: all 0.3s;
        pointer-events: none;
      }
      .city-node:hover {
        fill: #fff;
        stroke: var(--neon-blue);
        stroke-width: 8px;
      }
      .city-node.wrong-choice {
        fill: var(--neon-pink);
        stroke: var(--neon-pink);
        pointer-events: none;
        opacity: 0.6;
      }
      .city-node.correct-choice {
        fill: var(--neon-green);
        stroke: var(--neon-green);
      }

      #ui-layer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
      }

      #top-hud {
        position: absolute;
        top: 60px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--glass);
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 10px 30px;
        border-radius: 50px;
        display: flex;
        gap: 40px;
        backdrop-filter: blur(15px);
        z-index: 10;
        pointer-events: auto;
      }

      .hud-group {
        display: flex;
        flex-direction: column;
        align-items: center;
        min-width: 70px;
      }
      .hud-item {
        font-size: 0.7rem;
        color: rgba(255, 255, 255, 0.5);
        text-transform: uppercase;
        letter-spacing: 1.5px;
        margin-bottom: 2px;
      }
      .hud-val {
        color: var(--neon-blue);
        font-weight: 800;
        font-size: 1.2rem;
      }

      .toggle-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: pointer;
      }
      .toggle-switch {
        width: 40px;
        height: 20px;
        background: #333;
        border-radius: 20px;
        position: relative;
        transition: 0.3s;
        border: 1px solid #444;
      }
      .toggle-knob {
        width: 16px;
        height: 16px;
        background: white;
        border-radius: 50%;
        position: absolute;
        top: 1px;
        left: 2px;
        transition: 0.3s;
      }
      .active .toggle-switch {
        background: var(--neon-blue);
      }
      .active .toggle-knob {
        left: 21px;
      }

      #prompt-container {
        position: absolute;
        top: 22%;
        width: 100%;
        text-align: center;
        text-shadow: 0 5px 25px black;
        padding: 0 20px;
        box-sizing: border-box;
      }
      #find-label {
        font-size: 1.2rem;
        text-transform: uppercase;
        color: #888;
        letter-spacing: 4px;
        margin: 0;
      }
      #main-prompt {
        font-size: 1.8rem;
        font-weight: 900;
        margin: 5px 0 0;
        transition: all 0.4s;
        letter-spacing: 0.5px;
        line-height: 1.3;
      }
      #sub-prompt {
        font-size: 1.1rem;
        color: var(--neon-blue);
        margin-top: 8px;
        letter-spacing: 1px;
      }

      .wrong-state-highlight {
        color: var(--neon-amber);
        font-weight: 800;
      }

      #city-tooltip {
        position: absolute;
        background: rgba(0, 0, 0, 0.9);
        border: 1px solid var(--neon-blue);
        color: white;
        padding: 5px 12px;
        border-radius: 4px;
        font-size: 0.85rem;
        pointer-events: none;
        opacity: 0;
        transform: translate(-50%, -150%);
        white-space: nowrap;
        z-index: 50;
      }

      #fact-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.95);
        backdrop-filter: blur(20px);
        z-index: 100;
        display: flex;
        justify-content: center;
        align-items: center;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
      }
      #fact-overlay.show {
        opacity: 1;
        pointer-events: auto;
      }
      .fact-card {
        background: #111;
        border: 2px solid var(--neon-blue);
        border-radius: 20px;
        padding: 45px;
        max-width: 500px;
        width: 92%;
        text-align: center;
      }
      .fact-status {
        font-weight: 800;
        letter-spacing: 4px;
        margin-bottom: 12px;
        font-size: 1.1rem;
        text-transform: uppercase;
      }
      .status-correct {
        color: var(--neon-green);
      }
      .status-wrong {
        color: var(--neon-pink);
      }
      .fact-city {
        font-size: 2.6rem;
        margin: 0 0 15px;
        color: white;
        font-weight: 900;
      }
      .fact-body {
        color: #ddd;
        line-height: 1.7;
        margin-bottom: 35px;
        font-size: 1.1rem;
      }
      .next-btn {
        background: var(--neon-blue);
        color: #000;
        border: none;
        padding: 16px 45px;
        font-weight: 800;
        border-radius: 40px;
        cursor: pointer;
        text-transform: uppercase;
        transition: 0.2s;
      }
      .next-btn:hover {
        background: white;
        transform: scale(1.05);
      }

      @media (max-width: 600px) {
        #top-hud {
          gap: 20px;
          padding: 10px 20px;
        }
        #main-prompt {
          font-size: 1.4rem;
        }
      }
    </style>
  </head>
  <body>
    <div id="city-tooltip">City Name</div>
    <div id="map-stage"></div>

    <div id="ui-layer">
      <div id="top-hud">
        <div class="hud-group">
          <span class="hud-item">Target</span>
          <span id="target-state" class="hud-val">--</span>
        </div>
        <div class="hud-group">
          <span class="hud-item">Score</span>
          <span id="score-val" class="hud-val">0</span>
        </div>
        <div
          class="hud-group toggle-container active"
          id="mode-toggle"
          onclick="toggleMode()"
        >
          <span class="hud-item" id="mode-label">Capital</span>
          <div class="toggle-switch">
            <div class="toggle-knob"></div>
          </div>
        </div>
      </div>
      <div id="prompt-container">
        <p id="find-label">Initializing...</p>
        <h1 id="main-prompt">Connecting Satellite...</h1>
        <div id="sub-prompt"></div>
      </div>
    </div>

    <div id="fact-overlay">
      <div class="fact-card">
        <div class="fact-status" id="fact-status">Result</div>
        <div class="fact-city" id="fact-city-name">City</div>
        <div class="fact-body" id="fact-text">Fact</div>
        <button class="next-btn" id="next-action-btn">Continue</button>
      </div>
    </div>

    <script>
      let svg, g, zoom, projection, path;
      let width, height;
      let currentTargetAbbr = "";
      let currentPhase = "MAP_SELECTION";
      let score = 0;
      let visited = new Set();
      let currentScale = 1;
      let isCapitalMode = true;
      let targetCityName = "";

      window.onload = initGame;

      async function initGame() {
        width = window.innerWidth;
        height = window.innerHeight;
        const container = d3.select("#map-stage");
        svg = container
          .append("svg")
          .attr("viewBox", `0 0 ${width} ${height}`)
          .attr("preserveAspectRatio", "xMidYMid meet");
        g = svg.append("g");
        zoom = d3
          .zoom()
          .scaleExtent([1, 15])
          .on("zoom", (e) => {
            g.attr("transform", e.transform);
            currentScale = e.transform.k;
            d3.selectAll(".city-node")
              .attr("r", 6 / currentScale)
              .attr("stroke-width", 2 / currentScale);
          });
        svg.call(zoom);

        try {
          const us = await d3.json(
            "https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json",
          );
          const stateFeatures = topojson.feature(
            us,
            us.objects.states,
          ).features;
          projection = d3
            .geoAlbersUsa()
            .fitSize([width, height], topojson.feature(us, us.objects.states));
          path = d3.geoPath().projection(projection);

          const nameToAbbr = Object.entries(gameData).reduce(
            (acc, [abbr, data]) => {
              acc[data.name] = abbr;
              return acc;
            },
            {},
          );

          g.selectAll("path")
            .data(stateFeatures)
            .enter()
            .append("path")
            .attr("d", path)
            .attr("class", d => {
                        if (d.properties.name === "District of Columbia") return "state reg-northeast";
                        const abbr = nameToAbbr[d.properties.name];
                        const region = gameData[abbr] ? gameData[abbr].region : "unknown";
                        return `state reg-${region}`;
                    })
                    .attr("id", d => {
                        if (d.properties.name === "District of Columbia") return "state-DC";
                        const abbr = nameToAbbr[d.properties.name];
                        return abbr ? `state-${abbr}` : null;
                    })
            .on("click", handleStateClick);

          startRound();
        } catch (err) {
          console.error(err);
        }
      }

      function toggleMode() {
        if (currentPhase === "CITY_SELECTION") return;
        isCapitalMode = !isCapitalMode;
        const container = document.getElementById("mode-toggle");
        const label = document.getElementById("mode-label");
        if (isCapitalMode) {
          container.classList.add("active");
          label.innerText = "Capital";
        } else {
          container.classList.remove("active");
          label.innerText = "Fact";
        }
      }

      function startRound() {
        const keys = Object.keys(gameData);
        const available = keys.filter((k) => !visited.has(k));
        if (available.length === 0) {
          alert("Game Complete!");
          visited.clear();
          score = 0;
          startRound();
          return;
        }

        currentTargetAbbr =
          available[Math.floor(Math.random() * available.length)];
        visited.add(currentTargetAbbr);

        currentPhase = "MAP_SELECTION";
        resetZoom();
        d3.selectAll(".state").classed("active-focused", false);
        d3.selectAll(".city-node").remove();
        document.getElementById("fact-overlay").classList.remove("show");

        document.getElementById("find-label").innerText = "Find State";
        document.getElementById("main-prompt").innerText =
          gameData[currentTargetAbbr].name;
        document.getElementById("target-state").innerText = currentTargetAbbr;
        document.getElementById("sub-prompt").innerText = "";
        updateScoreUI();
      }

      function handleStateClick(event, d) {
        if (currentPhase !== "MAP_SELECTION") return;
        const clickedId = this.id;
        const clickedAbbr = clickedId ? clickedId.replace("state-", "") : null;

        if (clickedAbbr === currentTargetAbbr) {
          score += 10;
          updateScoreUI();
          flashState(this, "correct");
          transitionToCityPhase(d, clickedAbbr);
        } else {
          score -= 10;
          updateScoreUI();
          flashState(this, "wrong");
          let wrongName = gameData[clickedAbbr]
            ? gameData[clickedAbbr].name
            : "unknown territory";
          if (clickedAbbr === "DC") wrongName = "Washington DC";
          const targetName = gameData[currentTargetAbbr].name;
          document.getElementById("find-label").innerText = "Find";
          document.getElementById("main-prompt").innerHTML = `${targetName}`;
          document.getElementById("sub-prompt").innerHTML =
            `That is <span class="wrong-state-highlight">${wrongName}</span>`;
        }
      }

      function transitionToCityPhase(geoData, abbr) {
        currentPhase = "CITY_SELECTION";
        zoomToState(geoData);
        d3.select(`#state-${abbr}`).classed("active-focused", true);

        const data = gameData[abbr];
        document.getElementById("find-label").innerText = "Find";
        document.getElementById("sub-prompt").innerText = "";

        if (isCapitalMode) {
          targetCityName = data.capital;
          document.getElementById("main-prompt").innerText =
            `The capital of ${data.name}`;
        } else {
          const cityNames = Object.keys(data.cities);
          targetCityName =
            cityNames[Math.floor(Math.random() * cityNames.length)];
          document.getElementById("main-prompt").innerText =
            data.facts[targetCityName];
        }

        plotCities(abbr);
        setTimeout(() => {
          d3.selectAll(".city-node").style("pointer-events", "auto");
        }, 800);
      }

      function plotCities(abbr) {
        const data = gameData[abbr];
        const nodes = Object.entries(data.cities)
          .map(([name, coords]) => {
            const projected = projection(coords);
            return projected
              ? { name, x: projected[0], y: projected[1] }
              : null;
          })
          .filter((n) => n);

        g.selectAll(".city-node")
          .data(nodes)
          .enter()
          .append("circle")
          .attr("class", "city-node")
          .attr("cx", (d) => d.x)
          .attr("cy", (d) => d.y)
          .attr("r", 0)
          .on("mouseover", showTooltip)
          .on("mousemove", moveTooltip)
          .on("mouseout", hideTooltip)
          .on("click", (e, d) => handleCityClick(e, d, abbr))
          .transition()
          .duration(500)
          .delay(400)
          .attr("r", 6 / currentScale);
      }

      function handleCityClick(event, cityNode, abbr) {
        const data = gameData[abbr];
        const isCorrect = cityNode.name === targetCityName;
        const dot = d3.select(event.currentTarget);

        if (isCorrect) {
          dot.classed("correct-choice", true);
          score += 10;
          updateScoreUI();
          showFact(cityNode.name, abbr, "CORRECT", "status-correct");
        } else {
          dot.classed("wrong-choice", true);
          score -= 10;
          updateScoreUI();
          showFact(cityNode.name, abbr, "INCORRECT", "status-wrong");
        }
      }

      function showFact(cityName, abbr, status, statusClass) {
        const data = gameData[abbr];
        const overlay = document.getElementById("fact-overlay");
        const btn = document.getElementById("next-action-btn");

        document.getElementById("fact-status").innerText = status;
        document.getElementById("fact-status").className =
          `fact-status ${statusClass}`;
        document.getElementById("fact-city-name").innerText = cityName;
        document.getElementById("fact-text").innerHTML = data.facts[cityName];

        btn.innerText =
          status === "CORRECT" ? "Next Mission" : "Keep Searching";
        btn.onclick =
          status === "CORRECT"
            ? resetGameRound
            : () => overlay.classList.remove("show");

        overlay.classList.add("show");
      }

      function updateScoreUI() {
        document.getElementById("score-val").innerText = score;
      }
      function showTooltip(e, d) {
        const tt = document.getElementById("city-tooltip");
        tt.innerText = d.name;
        tt.style.opacity = 1;
      }
      function moveTooltip(e) {
        const tt = document.getElementById("city-tooltip");
        tt.style.left = e.pageX + "px";
        tt.style.top = e.pageY + "px";
      }
      function hideTooltip() {
        document.getElementById("city-tooltip").style.opacity = 0;
      }
      function resetGameRound() {
        startRound();
      }

      function zoomToState(d) {
        const b = path.bounds(d);
        const s = Math.max(
          1,
          Math.min(
            10,
            0.7 /
              Math.max(
                (b[1][0] - b[0][0]) / width,
                (b[1][1] - b[0][1]) / height,
              ),
          ),
        );
        const t = [
          width / 2 - (s * (b[0][0] + b[1][0])) / 2,
          height / 2 - (s * (b[0][1] + b[1][1])) / 2,
        ];
        svg
          .transition()
          .duration(1000)
          .call(zoom.transform, d3.zoomIdentity.translate(t[0], t[1]).scale(s));
      }

      function resetZoom() {
        svg.transition().duration(1000).call(zoom.transform, d3.zoomIdentity);
      }
      function flashState(el, type) {
        d3.select(el).classed(type + "-flash", true);
        setTimeout(() => d3.select(el).classed(type + "-flash", false), 500);
      }
    </script>
  </body>
</html>
